<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediaAI | Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>
<body class="bg-black text-white min-h-screen">

    <nav class="p-5 border-b border-zinc-800 flex justify-between items-center bg-zinc-900/50 backdrop-blur-md sticky top-0">
        <a href="dashboard.html" class="text-blue-500 font-bold">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <h2 class="text-lg font-bold">ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„ÙÙƒ</h2>
    </nav>

    <main class="max-w-xl mx-auto p-6 mt-10">
        <div class="bg-zinc-900 p-8 rounded-[2.5rem] border border-zinc-800 shadow-2xl text-center">
            
            <div class="relative w-28 h-28 mx-auto mb-8">
                <img id="profileImg" src="https://via.placeholder.com/150" class="w-full h-full rounded-full object-cover border-4 border-blue-600 shadow-xl">
                <label for="fileInput" class="absolute bottom-0 right-0 bg-blue-600 p-2 rounded-full cursor-pointer hover:bg-blue-700 transition shadow-lg">
                    ğŸ“·
                    <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="uploadImage(this)">
                </label>
            </div>

            <div class="text-right mb-6">
                <label class="block text-zinc-500 text-sm mb-2 mr-2">Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶</label>
                <input id="newName" type="text" class="w-full p-4 rounded-2xl bg-black border border-zinc-800 focus:border-blue-500 outline-none transition" placeholder="Ù…Ø«Ø§Ù„: Ø·Ù„Ø§Ù„">
            </div>

            <button onclick="updateProfile()" id="saveBtn" class="w-full py-4 bg-blue-600 rounded-2xl font-bold hover:bg-blue-700 transition-all">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª âœ…</button>
            
            <p id="statusMsg" class="mt-4 text-sm font-medium"></p>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD0qsSRI5c8oNjWZMupSe59sQ5OsYr4MUE",
            authDomain: "mymediaai.firebaseapp.com",
            projectId: "mymediaai",
            storageBucket: "mymediaai.appspot.com", // ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù…ÙˆØ¬ÙˆØ¯
            appId: "1:1052949171163:web:ba0bd6e2ef11a6c32e35fe"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                document.getElementById('newName').value = user.displayName || "";
                if (user.photoURL) document.getElementById('profileImg').src = user.photoURL;
            } else {
                window.location.href = "login.html";
            }
        });

        // ÙˆØ¸ÙŠÙØ© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
        async function uploadImage(input) {
            const file = input.files[0];
            const user = firebase.auth().currentUser;
            const msg = document.getElementById('statusMsg');
            
            if (!file) return;

            msg.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...";
            const storageRef = storage.ref(`avatars/${user.uid}`);

            try {
                const snapshot = await storageRef.put(file);
                const url = await snapshot.ref.getDownloadURL();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Firebase Auth
                await user.updateProfile({ photoURL: url });
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                document.getElementById('profileImg').src = url;
                
                msg.innerText = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©!";
                msg.className = "mt-4 text-green-500";
            } catch (error) {
                msg.innerText = "âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: " + error.message;
            }
        }

        async function updateProfile() {
            const user = firebase.auth().currentUser;
            const name = document.getElementById('newName').value;
            const btn = document.getElementById('saveBtn');

            btn.disabled = true;
            try {
                await user.updateProfile({ displayName: name });
                await db.collection("users").doc(user.uid).set({
                    displayName: name,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
                window.location.href = "dashboard.html";
            } catch (e) {
                alert("Ø®Ø·Ø£: " + e.message);
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
